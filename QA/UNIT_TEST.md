# envault ユニットテストガイド

このドキュメントでは、envault プロジェクトのユニットテスト方法と各テストの概要について説明します。

## 自動テストの実行方法

envault には包括的な自動テストが実装されています。以下のコマンドで実行できます：

```bash
# プロジェクトのルートディレクトリで実行（すべてのテストを実行）
go test ./...

# 個別のパッケージをテスト
go test ./internal/crypto
go test ./internal/env
go test ./internal/file
go test ./internal/cli
go test ./pkg/utils

# テストカバレッジの確認
go test ./... -cover

# 詳細なテスト出力
go test ./... -v
```

## テストカバレッジ

各パッケージのテストカバレッジを確認するには以下のコマンドを使用します：

```bash
go test ./internal/crypto -cover
go test ./internal/env -cover
go test ./internal/file -cover
go test ./internal/cli -cover
go test ./pkg/utils -cover
```

## 各パッケージのテスト内容

### 1. 暗号化・復号化機能 (`internal/crypto`)

```bash
go test ./internal/crypto
```

以下の機能をテストします：

- AES-256-GCMによる暗号化の正確性
- 暗号化されたデータの安全性検証
- ソルトとnonceのランダム性検証
- 正しいパスワードでの復号化の成功
- 誤ったパスワードでの復号化の失敗
- 無効なデータ形式の検出と適切なエラー処理

### 2. 環境変数の解析 (`internal/env`)

```bash
go test ./internal/env
```

以下の機能をテストします：

- 基本的な環境変数の解析
- 空行とコメントの処理
- 引用符付きの値の処理
- 無効な形式の検出
- エクスポートスクリプトの生成
- アンセットスクリプトの生成
- 特殊文字を含む値の適切なエスケープ
- 環境変数のコメント保持と処理

### 3. ファイル操作 (`internal/file`)

```bash
go test ./internal/file
```

以下の機能をテストします：

- ファイルの読み書き操作
- 暗号化ファイルの形式検証
- ファイル存在確認と適切なエラー処理
- ファイルパーミッションの適切な設定（0600）
- デフォルトファイル名の取り扱い
- 空ファイルの適切な処理

### 4. CLI インターフェース (`internal/cli`)

```bash
go test ./internal/cli
```

以下の機能をテストします：

- Cobraベースのコマンドライン解析
- 各コマンド（encrypt, export, unset, dump, version, help）の基本的な動作
- コマンドラインフラグとオプションの適切な処理
- サブコマンド（export select）の処理
- 入出力リダイレクションの適切な処理
- エラー状態の適切な処理とエラーメッセージ

### 5. ユーティリティ関数 (`pkg/utils`)

```bash
go test ./pkg/utils
```

以下の機能をテストします：

- パスワード入力関連の機能
- シェルスクリプト実行機能
- その他の共通ユーティリティ関数

## モックとテストデータ

テストでは以下のモックとテストデータを使用しています：

- `internal/crypto/test`: 暗号化テスト用のダミーデータとベクトル
- `internal/env/test`: 環境変数のサンプルと期待される解析結果
- `internal/file/test`: ファイル操作テスト用のダミーファイル
- `internal/cli/test`: CLI動作をテストするためのダミー入力と出力

## テストの追加と拡張

新しい機能を実装した際は、対応するテストも追加してください。テストの作成手順：

1. 該当するパッケージのテストファイル（*_test.go）を開く
2. 新しいテスト関数を追加（命名規則: `Test関数名`）
3. テストケースとアサーションを実装
4. `go test ./パッケージパス` でテストを実行して確認

## CI/CD 統合

将来的には、GitHub Actions などを使用して以下を自動化する予定です：

1. プルリクエスト時の自動テスト実行
2. テストカバレッジレポートの生成と履歴管理
3. テスト失敗時の自動通知

## テストに関する注意事項

- パスワード入力を要求するテストは `t.Skip()` でスキップされています
- テスト実行時は一時ファイルが自動的に作成・削除されます
- 環境変数 `ENVAULT_TEST_SKIP_INTERACTIVE=1` を設定すると対話式テストをスキップできます